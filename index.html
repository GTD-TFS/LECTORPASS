<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>OCR Offline ‚Üí Excel</title>

  <link rel="manifest" href="manifest.webmanifest">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>

  <style>
    body {
      font-family: system-ui,sans-serif;
      background:#f4f4f4;
      color:#222;
      text-align:center;
      padding:2rem;
    }
    button {
      background:#007bff;
      color:#fff;
      border:none;
      border-radius:8px;
      padding:1rem 2rem;
      font-size:1.1rem;
      cursor:pointer;
      margin-top:1rem;
    }
    button:hover {background:#0056b3;}
    #log {white-space:pre-wrap;text-align:left;
      background:#fff;border:1px solid #ccc;
      border-radius:6px;padding:1rem;margin-top:2rem;
      max-height:300px;overflow:auto;}
  </style>
</head>
<body>
  <h1>Captura y exportaci√≥n offline</h1>
  <p>Pulsa para hacer una foto o elegir un documento.</p>

  <input id="fileInput" type="file" accept="image/*" capture="environment" hidden>
  <button id="captureBtn">üì∏ Capturar / Elegir imagen</button>

  <div id="log"></div>

  <!-- üîß Librer√≠as locales -->
  <script src="opencv.js"></script>
  <script src="exifr.min.js"></script>
  <script src="xlsx.full.min.js"></script>
  <script src="tesseract.min.js"></script>
  <script src="worker.min.js"></script>
  <script src="tesseract-core-simd.js"></script>

  <!-- Parser MRZ (ESM) -->
  <script type="module" src="mrz.esm.js"></script>

  <script>
  const log = msg => {
    document.getElementById('log').textContent += msg + "\\n";
    console.log(msg);
  };
  const input = document.getElementById('fileInput');
  document.getElementById('captureBtn').onclick = () => input.click();

  input.onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;
    log("üì∏ Imagen seleccionada.");

    const image = URL.createObjectURL(file);

    // ---------- OCR ----------
    log("üîç Iniciando OCR...");
    const { createWorker } = Tesseract;
    const worker = await createWorker({
      workerPath: 'worker.min.js',
      corePath: 'tesseract-core-simd.js',
      langPath: '.',
      logger: m => log(m.status + " " + (m.progress ? Math.round(m.progress*100)+"%" : "")),
    });
    await worker.loadLanguage('spa+eng');
    await worker.initialize('spa+eng');
    const { data: { text } } = await worker.recognize(image);
    await worker.terminate();
    log("‚úÖ OCR completado.");

    // ---------- MRZ ----------
    const mrzLines = text.split(/\\n/).filter(l => l.includes('<'));
    if (mrzLines.length >= 2) {
      log("üßæ MRZ detectada. Analizando...");
      try {
        const { parse } = await import('./mrz.esm.js');
        const res = parse(mrzLines.join('\\n'));
        log("‚úÖ MRZ v√°lida: " + JSON.stringify(res.fields, null, 2));
      } catch (err) {
        log("‚ö†Ô∏è Error interpretando MRZ: " + err);
      }
    } else {
      log("‚ö†Ô∏è No se detect√≥ MRZ, usando OCR general.");
    }

    // ---------- Excel ----------
    log("üìä Cargando plantilla Excel...");
    const data = await (await fetch('1234.xlsx')).arrayBuffer();
    const wb = XLSX.read(data);
    const ws = wb.Sheets[wb.SheetNames[0]];

    // Escribe una marca para confirmar escritura
    XLSX.utils.sheet_add_aoa(ws,[["Procesado offline OK"]],{origin:"B1"});

    const out = XLSX.write(wb,{bookType:"xlsx",type:"array"});
    const blob = new Blob([out],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='salida.xlsx';
    document.body.appendChild(a); a.click(); a.remove();
    log("üíæ Excel exportado (salida.xlsx).");
  };
  </script>
</body>
</html>
